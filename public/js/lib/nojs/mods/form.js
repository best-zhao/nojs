/*nolure@vip.qq.com*/define("lib/nojs/mods/form",["lib/jquery/jquery","lib/nojs/ui"],function(require){function getMessage(a,b){return a||form.message[b]||""}var $=require("lib/jquery/jquery"),ui=require("lib/nojs/ui"),form=function(a){this.options=a=config(a),this.button=a.button,this.formSubmit=this.button&&this.button.length?!1:!0;var b=$("string"==typeof a.form?"#"+a.form:a.form);if(this.form=b||this.button&&this.button.closest("form"),this.form&&this.form.length){var c="form"==this.form[0].tagName.toLowerCase();(!this.formSubmit||c)&&(c&&!this.button&&(this.button=this.form.find('[type="submit"]')),this.rules=a.rules,this.item=[],a.showIco=0==a.showIco?!1:a.showIco||!0,a.focusOnError=0==a.focusOnError?!1:!0,this.checkMode=a.checkMode||"submit",this.init())}},config=function(a){var b="function"==typeof form.config?form.config(a):form.config;return $.extend(!0,{},b,a)};return form.prototype={init:function(rules){var i,j,name,_rules=rules||this.rules,T=this;if(this.rules=$.extend(!0,{},_rules),this.item=[],!_rules){var item=this.form.find("[data-rule]");item.each(function(){var rule=eval("({"+$(this).data("rule")+"})"),rules={};this.name&&(T.rules[this.name]=rule)})}for(i in this.rules)if(name=$.trim(i),name.indexOf(" ")>0)for(name=name.split(" "),j=0;j<name.length;j++)T.push(name[j]);else T.push(name);!rules&&this.bind()},push:function(a,b){function c(a,b){a&&(a="function"==typeof a?a.call(b):a,b.data("replace",a))}var c,d=this,e=d.form.find("[name='"+a+"']");if(e.length){b=this.rules[a],c(b.replace,e);var f=d.type(e);("checkbox"!=f&&"radio"!=f||void 0!==b.isNull)&&(d.item.push(e),"input"==f||"textarea"==f?!function(a,b){if(a.off("keyup.validate").on("keyup.validate",function(){$(this).data("state",!1)}),b.$focus&&a.off("focus.validate").on("focus.validate",function(){$(this).data("state")||form.state($(this),"focus",b.$focus,d.options.icoPosition)}),d.formSubmit||"input"!=d.type(a)||a.off("keyup.validate").on("keyup.validate",function(a){$(this).data("state",!1),13==a.keyCode&&d.button.click()}),"password"===a.attr("type")){var e,f,g=b.confirmPas;if(g&&g.name){e=d.form.find("[name='"+g.name+"']"),f="rePas"+ +new Date,a.off("keyup.validate").on("keyup.validate",function(){a.data("state",!1),e.data("state",!1)}),e.off("keyup.validate").on("keyup.validate",function(){e.data("state",!1)}),form.reg[f]=function(b){return a.val()==b?!0:!1};var h=$.extend(!0,{},b,{isNull:"undefined"!=typeof g.isNull?g.isNull:"请填写确认密码"});delete h.confirmPas,h[f]="undefined"!=typeof g.error?g.error:"两次密码输入不一致",c(h.replace,e),e.data("formInit",!0),e.data("rule",h),e.data("state",!1),d.rules[g.name]=h,d.item.push(e)}}}(e,b):("checkbox"==f||"radio"==f)&&(_rule={},_rule.isLength=b.isLength||[],_rule.isLength[0]=_rule.isLength[0]||b.isNull,_rule.isLength[1]=_rule.isLength[1]||{},_rule.isLength[1].min="radio"==f?1:_rule.isLength[1].min||1,b=_rule),e.data("formInit",!0),e.data("rule",b),e.data("state",!1))}},bind:function(){var a,b,c,d=this;if(this.form.submit(function(){return d.submit()}),this.formSubmit||this.button.click(function(){return"form"==d.form[0].tagName.toLowerCase()?d.form.submit():d.submit(),!1}),this.checkMode&&("keyup"==this.checkMode||"blur"==this.checkMode))for(var e=0;e<d.item.length;e++)a=d.item[e],c=this.type(a),"input"==c||"textarea"==c?("keyup"==this.checkMode&&(this.checkMode="keyup blur"),a.on(this.checkMode,function(){m=$(this),clearTimeout(b),b=setTimeout(function(){d.check(m)},90)})):("checkbox"==c||"select"==c)&&a.on("change",function(){d.check($(this))})},type:function(a){if(!a||!a.length)return"text";var b=a[0].tagName.toLowerCase(),c=b;return"input"==b&&("checkbox"==a.attr("type")?c="checkbox":"radio"==a.attr("type")?c="radio":"hidden"==a.attr("type")&&(c="hidden")),c},check:function(a,b,c){var d="string"==typeof a?a:a[0].name;a=this.form.find('[name="'+d+'"]');var e=this.type(a);if(!a.length||a.is(":hidden")&&"hidden"!=e)return!0;a.data("formInit")||this.push(d);var f,g,h,i,j=this,k=c||a.data("rule"),l=!1,m="",n=form.state,o=form.reg;if(!k)return!0;if("checkbox"==e||"radio"==e)return f=a.filter(":checked").length,g=k.isLength,m=getMessage(g[0],"isLength"),h=g[1],o.isLength(f,h,a)?(l=!0,0!==b&&this.options.showIco&&n(a.last(),"error"==this.options.showIco?null:"ok",this.options.icoPosition)):(l=!1,0!==b&&this.options.showIco&&n(a.last(),"error",m,this.options.icoPosition),a.last().focus()),a.data("state",l),l;if(f=a.val(),"undefined"==typeof k.isNull&&("input"==e||"textarea"==e)&&""==f)return a.data("state",!0),!0;if(("input"==e||"textarea"==e)&&1==a.data("state")&&""!=f)return!0;for(var p in k)if(g=k[p],o[p]?("array"==$.type(g)?(m=g[0],h=g[1]):m=g,m="function"==typeof m?m.call(a):m,m=getMessage(m,p),"remote"==p&&(a.data("tip",m),b&&(h.callback=function(){j.submit()})),i="select"==e&&0==f?!1:o[p].call(j,f,h,a),1==i?(l=!0,0!==b&&this.options.showIco&&n(a,"error"==this.options.showIco?null:"ok",null,this.options.icoPosition)):0==i?(0!==b&&this.options.showIco&&n(a,"error",m,this.options.icoPosition),b&&(this.options.focusOnError&&a.focus(),"hidden"==a[0].type&&a.data("replace")&&$(window).scrollTop(a.data("replace").offset().top)),l=!1):"pending"==i&&(0!==b&&this.options.showIco&&n(a,"pending","loading...",this.options.icoPosition),l=!1)):l=!0,0==l)break;return a.data("state",l),0!==b&&this.options.onCheck&&this.options.onCheck.call(this,l),l},verify:function(a){a=a||0;for(var b in this.rules)if(!this.check(b,a))return this.options.onSubmitError&&this.options.onSubmitError.call(this),!1},submit:function(){if(this.state||this.options.onBeforeSubmit&&0==this.options.onBeforeSubmit.call(this))return!1;if(0==this.verify(!0))return!1;this.state=!0;var a=this.options.onSubmit&&this.options.onSubmit.call(this);return this.options.ajaxSubmit?(this.ajaxSubmit(),!1):(this.state=null,a)},reset:function(){var a=this.form[0];this.item.forEach(function(a){a.data("state",null)}),"form"==a.tagName.toLowerCase()?a.reset():this.form.find("input, textarea, select").filter(function(){return"submit"!=this.type&&"button"!=this.type}).val(""),this.form.find("span.nj_f_tip").remove()},ajaxSubmit:function(){var a=this,b=$.extend({url:this.form[0].action,data:this.form.serialize(),type:"post",dataType:"json",context:this},this.options.ajaxSubmit),c=b.success;b.success=function(b){a.state=null,c&&c.call(this,b)};var d=b.beforeSend;return"function"==typeof d&&0==d()?void(a.state=null):(d&&delete b.bs,void("jsonp"==b.dataType&&"post"==b.type?form.post(this.form,b):$.ajax(b)))}},form.state=function(a,b,c,d){c=c||"";var e,f,g,h=a;a.data("replace")&&(h=a.data("replace"),d=d||"append"),a.removeClass("error pending"),h.siblings(".nj_f_tip").remove().end().find(".nj_f_tip").remove(),b&&(d=d||"after",("error"==b||"pending"==b)&&a.addClass(b),b="pending"==b?"loading":b,g=a.offset(),e=$('<span class="nj_f_tip"><span class="tip_ico nj_ico n_i_'+b+'">'+(ui.config.iconText[b]||"")+'</span><span class="tip_con">'+c+"</span></span>"),f=e.find("span.tip_ico"),h[d](e),e.addClass("nj_f_"+b))},form.reg={isNull:function(a){return""!=a.replace(/\s/g,"")?!0:!1},isEmail:function(a){var b=/^\w+(?:[-+.']\w+)*@\w+(?:[-.]\w+)*\.\w+(?:[-.]\w+)*$/;return b.test(a)?!0:!1},isQQ:function(a){var b=/^\s*[.0-9]{5,10}\s*$/;return b.test(a)?!0:!1},isUrl:function(a){if("string"!=typeof a)return!1;a=a.split(/[\?#]/)[0];var b=/^(?:http(?:s)?:\/\/)?([\w-]+\.)+[\w-]+(?:\/[\w\W]*)?$/;return b.test(a)?!0:!1},isMobile:function(a){var b=/^(13[0-9]|14[0-9]|15[0-9]|18[0-9])[0-9]{8}$/;return b.test(a)?!0:!1},isTel:function(a){var b=/^\d{2,5}?[-]?\d{5,8}([-]\d{0,1})?$/;return b.test(a)?!0:!1},isTel400:function(a){var b=/^(400)[-]?\d{3}[-]?\d{4}$/;return b.test(a)?!0:!1},isIdcard:function(a){var b=/^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}(?:\d|[a-zA-Z])$/;return b.test(a)?!0:!1},specialCode:function(a){return/^[\u4e00-\u9fa5\w]*$/.test(a)?!0:!1},isLength:function(a,b){if(b){var c=function(a){for(var b=0,c=0;c<a.length;c++)b+=/[\u4e00-\u9fa5]/.test(a.charAt(c))?2:1;return b},b=b,d="string"==typeof a?c(a):"number"==typeof a?a:0,e=!0;return b.min&&d<b.min&&(e=!1),b.max&&d>b.max&&(e=!1),e}},isNum:function(val,opt){var opt=opt||{},p,test=!isNaN(val);return opt.decimals&&(p=eval("/^-?\\d+(?:\\.\\d{1,"+opt.decimals+"})?$/"),test=p.test(val)),(opt.min||0==opt.min)&&val<opt.min&&(test=!1),(opt.max||0==opt.max)&&val>opt.max&&(test=!1),"int"==opt.type&&-1!=val.indexOf(".")&&(test=!1),val.lastIndexOf(".")==val.length-1&&(test=!1),test},remote:function(a,b,c){var d,e=this;if(b=b||{},b.beforeSend&&0==b.beforeSend(c))return"pending";d=b.data=b.data||{},"function"==typeof b.data&&(d=b.data.call(this)||{}),b.name?d[b.name]=a:d[c.attr("name")]=a;var f=b.success;return $.ajax({url:b.url,type:b.type||"get",data:d,context:b.context,dataType:b.dataType||"json",success:function(a){f&&f(a,c),a&&1==a.state||1==a.status||b.check&&b.check(a)?(c.data("state",!0),form.state(c,"ok",a.info||"",e.options&&e.options.icoPosition),b.callback&&b.callback(),b.callback=null):(c.data("state",!1),form.state(c,"error",a.info||c.data("tip"),e.options&&e.options.icoPosition))}}),"pending"}},form.message={isNull:"不能为空",isEmail:"邮箱格式错误",isQQ:"qq号码格式错误",isUrl:"url格式错误",isMobile:"手机号码格式错误"},form.fill=function(a){a=a||{};var b,c,d,e,f=$(a.form||document.forms[0]),g=a.data;if(f.length&&"object"==$.type(g))for(b in g)c=f.find('[name="'+b+'"]'),c.length&&(d=c[0].type,e=g[b],"text"==d||"hidden"==d||"textarea"==d||"select-one"==d&&"string"==typeof e?c.val(e):"radio"==d?c.filter('[value="'+e+'"]').attr("checked","checked"):"checkbox"==d&&"array"==$.type(e)&&$.each(e,function(a,b){c.filter('[value="'+b+'"]').click()}))},form.parse=function(a,b){if(a&&a.length){var c,d=a.find("form"),e="form"==a[0].tagName.toLowerCase()?a:d.length?d:null;if(b=b||"string",e)c=e.serialize();else for(var f=a.find("input,textarea,select,button"),g=0,h=f.length,c={};h>g;g++)f[g].name&&(c[f[g].name]=f[g].value);return c}},form.post=function(a,b){b=b||{};var c="iframe_"+ +new Date,d=$('<iframe src="" name="'+c+'" style="display:none"></iframe>').appendTo(document.body),e="jsoncallback_"+ +new Date;a&&a.length&&(a[0].target=c,a[0].action=a[0].action.split("?")[0]+"?jsoncallback="+e,window[e]=function(a){b.complete&&b.complete.call(b,a),b.success&&b.success.call(b,a),delete window[e],d.remove(),d=null},b.beforeSend&&b.beforeSend.call(b),a[0].submit())},form});