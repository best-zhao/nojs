/*nolure@vip.qq.com*/define("lib/nojs/mods/waterfall",["lib/jquery/jquery"],function(require){function a(){var a=[],b=null,c=function(){for(var b=0;b<a.length;b++)a[b].end?a.splice(b--,1):a[b]();!a.length&&d()},d=function(){clearInterval(b),b=null};return function(d,e,f,g){var h,i,j,k,l,m=new Image;return m.src=d,m.complete?(e.call(m),void(f&&f.call(m))):(i=m.width,j=m.height,m.onerror=function(){g&&g.call(m),h.end=!0,m=m.onload=m.onerror=null},h=function(){k=m.width,l=m.height,(k!==i||l!==j||k*l>1024)&&(e.call(m),h.end=!0)},h(),m.onload=function(){!h.end&&h(),f&&f.call(m),m=m.onload=m.onerror=null},void(h.end||(a.push(h),null===b&&(b=setInterval(c,40)))))}}var b=require("lib/jquery/jquery"),c=function(d,e){this.element=b("#"+d),this.element.length&&(this.opt=e||{},this.item=null,this.temp=[],this.N=null,this.state=null,this.load=c.loadData,this.ready=null,this.loading=null,this.preLoadimg=1==this.opt.preLoadimg?a():!1,this.onSort=this.opt.onSort,this.page=null,(this.opt.autoWidth||this.opt.autoLoad)&&this.bindScroll(),this.init())};return c.prototype={init:function(){var a,b;if(this.item=this.element.find("div.waterfall_item"),this.N={colWidth:null,cols:null,colsPos:[]},this.temp=[],this.ready=0,this.state=!0,this.page=1,this.item.length){for(var c=0;c<this.item.length;c++)a=this.item.eq(c),this.temp[c]=a,a.css("opacity","0"),b=a.find(".pic img"),b.length;this.insert(null,!0)}else;},bindScroll:function(){function a(){window.clearTimeout(d),d=window.setTimeout(function(){f.N.cols&&Math.floor((f.element.parent().width()+f.N.margin)/f.N.colWidth)!=f.N.cols&&f.init(!0)},400)}function c(){if(!f.loading){var a;window.clearTimeout(e),e=window.setTimeout(function(){a=g.height()-(Math.min.apply(null,f.N.colsPos)+f.element.offset().top-g.scrollTop()),a+100>0&&f.load.call(f)},10)}}var d,e,f=this,g=b(window);f.opt.autoWidth&&g.resize(a),f.opt.autoLoad&&g.on("scroll.autoload",c)},insert:function(a,b){function c(){e.getSize(g,h),g.fadeTo(10,1),e.temp.length?setTimeout(function(){e.insert(null,b)},1):e.state=!1}function d(){var a=g.find(".pic img");e.preLoadimg&&a.length?e.preLoadimg(a.attr("src"),function(){var b=a.width()/this.width;a.height(this.height*b),c()}):c()}var e=this;if(this.temp.length){var f,g=this.temp.shift(),h=g.attr("data-col")||1;if(this.onSort&&this.onSort(g),this.item=this.element.find("div.waterfall_item"),f=this.item.length,this.ready)if(this.ready<this.N.cols)g.css({left:this.ready*this.N.colWidth,top:"0"});else{for(var i=[0,this.N.colsPos[0]],j=0;j<this.N.cols;j++)this.N.colsPos[j]<i[1]&&(i=[j,this.N.colsPos[j]]);g.css({left:i[0]*this.N.colWidth,top:i[1]})}else g.css({left:"0",top:"0"});this.ready+=h,g.css("display","block"),b||g.appendTo(this.element),d()}},dealData:function(a){var c,d=a.length,e=0;if(d){for(this.temp=[];d>e;e++)c=b(document.createElement("div")).attr("class","waterfall_item"),c.html(a[e]).css("opacity","0"),this.temp[e]=c;this.insert()}},getSize:function(a,b){this.item=this.element.find("div.waterfall_item");var c,d,e=this.item.length;if(e){this.N.colWidth||(this.N.colWidth=a.outerWidth(!0),this.N.margin=this.N.colWidth-a.outerWidth(),this.N.colWidth/=b),c=Math.floor((this.element.parent().width()+this.N.margin)/this.N.colWidth),this.N.cols!=c&&(this.N.cols=c,d=c*this.N.colWidth,d!=this.element.parent().width()&&this.element.width(d));var f,g,h,i,j=0;f=a.outerHeight(!0),f+=parseInt(a.css("top")),g=parseInt(a.css("left")),h=parseInt(g/this.N.colWidth);for(var j=0;b>j;j++)this.N.colsPos[h++]=f;i=Math.max.apply(null,this.N.colsPos),i>200&&this.element.height(i)}},setCol:function(a){for(var b=a.nextAll(),c=b.length,d=parseInt(a.css("left")),e=d/this.N.colWidth,f=parseInt(a.css("top"))+a.outerHeight(!0),g=0,h=0;c>h;h++)m=b.eq(h),parseInt(m.css("left"))/this.N.colWidth==e&&(h>g&&(g=h),m.css("top",f),f+=m.outerHeight(!0));this.N.colsPos[e]=parseInt(b.eq(g).css("top"))+b.eq(g).outerHeight(!0)}},c.dataTmpl=function(a){var c=['<a class="pic" href="productreview-<%=id%>.html"><img src="<%=pic%>" />','<span class="tit"><%=title%></span>',"</a>"].join("");return b.tmpl(c,a)},c.loadData=function(){return function(){var a,d=this.page,e=this;if(d>2)return void(this.opt.over&&this.opt.over.call(this));if(!this.loading&&!this.state){this.loading=!0,this.page=++d,this.opt.start&&this.opt.start.call(e);var f=this.opt.key,g=this.opt.url,h=this.opt.dataType||"html";f&&(g+=(g.indexOf("?")>0?"&":"?")+f+"="+d),b.getJSON(g,function(d){if(e.loading=!1,e.opt.end&&e.opt.end.call(e,d),1==d.status){var f,g=d.data;if(g){if("function"==typeof e.opt.data&&(g=e.opt.data(d),!g))return;if("html"==h){for(g=b(g),e.temp=[],f=0;f<g.length;f++)e.temp[f]=g.eq(f).css("opacity","0");e.insert()}else{for(a=[],f=0;f<g.length;f++)a[f]=c.dataTmpl(g[f]);e.dealData(a)}}}})}}}(),c});