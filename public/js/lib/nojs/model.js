/*nolure@vip.qq.com*/define("lib/nojs/model",["lib/jquery/jquery"],function(require){function syntaxParse(str,scope){function checkArgument(a){return a=$.trim(a),!a||reStr[a]||$keywords.indexOf(a)>=0||/^(\d|[^\w\$])/.test(a)?!1:!0}function initMethod(a,b){if("$key"!=a){var c=model,d=a.split("."),e=d[0],f=$.trim(d.slice(-1)[0]);if(!b&&e&&!/^(\$(?:key|data)\.)/.test(e+".")&&watchKey.indexOf(e)<0&&watchKey.push(e),void 0!==c[e]||void 0===window[e])for(var g,h=0,i=d.length,j=scope,k=0;i>h&&(g=$.trim(d[h]),g&&!/^true|false&/.test(g));h++){if(("$parent"==g||"$root"==g)&&(j=c[g+"Scope"],k=h+1),void 0!==c[g]){if(b&&h==i-2&&Array.prototype[f]&&"array"==$.type(c[g])){var l=d.slice(k,i-1).join(".");l=l?[l]:[];for(var m in j.subscriber)0==m.indexOf(l[0]+".")&&l.push(m);l.length&&watchKey.push({scope:j,key:l});break}}else c[g]=g!=f||b?noopMethod():void 0;c=c[g]}}}var model=scope.model,reStr={},data={watchKey:[],methods:[],vars:[]},watchKey=data.watchKey,methods=data.methods,vars=data.vars,skey="_nj_str_",akey="nj_arg_",n=0;str=str.replace(/"(?:\\"|[^"])*"|'(?:\\'|[^'])*'/g,function(a){if(a){var b=skey+ ++n;return reStr[b]=a,b}}),str=str.replace(/\)\s*{[\w\W]*}/g,")"),str.replace(/([\$\w\.]+)\s*\(/g,function(a,b){checkArgument(b)&&methods.indexOf(b)<0&&methods.push(b)}),str=str.replace(/\(([\s\w\$\(\),\.\+\-\*\/\%\!:\?=<>]*)\)/g,function(a,b){b=b.split(/[,\+\-\*\/\%\!:\?=]/),b.forEach(function(a){a=a.replace(/^\(|\)$/,""),a.indexOf("(")>0&&(a=a.split("("),methods.indexOf(a[0])<0&&methods.push(a[0]),a=a[1]),a=$.trim(a),checkArgument(a)&&vars.indexOf(a)<0&&vars.push(a)});var c=";"+akey+ ++n+";";return reStr[c]=a,c}),str=str.split(";");var regCompute=/[\+\-\*\/%\!=\?:<>\s]/,validStr=/[\$\w\.\+\-\*\/%\!=\?:<>]+/,keyword=/^(\$(?:parent|root)\.)/;str.forEach(function(a,b){if(str[b]=a=$.trim(a),a&&!reStr[";"+a+";"]&&validStr.test(a)&&!(methods.indexOf(a)>=0&&reStr[";"+str[b+1]+";"])){var c=a.split(regCompute);c.forEach(function(a){a=$.trim(a),checkArgument(a)&&vars.indexOf(a)<0&&methods.indexOf(a)<0&&vars.push(a)})}}),methods.forEach(function(a){initMethod(a,!0)});for(var i=0,n=vars.length,name;n>i;i++)name=vars[i]=vars[i].replace(/^this\./,""),checkArgument(name)?initMethod(name):(vars.splice(i,1),i--,n--);str=str.join(";");for(var i in reStr)str=str.replace(eval("/"+i+"/g"),reStr[i]);for(var i in reStr)str=str.replace(eval("/"+i+"/g"),reStr[i]);return data.str=str,data}function syntaxInitialize(a,b,c){if(a&&b){var d=$data(a,"$syntax");return d?d:(d=syntaxParse(b,c),$data(a,"$syntax",d),d)}}function getAllChildren(a,b){function c(a){if(a&&a.length)for(var b,e=0,f=a.length;f>e;e++)b=a[e],d(b),b&&1==b.nodeType&&c(b.childNodes)}function d(a){if(b.filter){var c=b.filter(a);c&&(e=e.concat(c))}else e.push(a)}b=b||{};var e=[];return a?(b.andSelf&&d(a),c("array"==$.type(a)?a:a.childNodes),e):e}function $data(a,b,c){return"undefined"==typeof c?ie8?$data.get(a,b):a[b]:void(ie8?$data.set(a,b,c):a[b]=c)}function nodeToArray(a){return ie8?function(){for(var b=[],c=0,d=a.length;d>c;c++)b.push(a[c]);return b}():slice.call(a,0)}function getAttribute(a,b){var c=["var value;","try{","value = a."+b,"}catch(e){","value = window."+b,"}","return value;"].join("");return new Function("a",c)(a)}function Module(el,model,options){this.element=el;var $el=$(el);this.options=options=options||{},this.subscriber={};var self=this,_model=model,modelType=$.type(model);"function"!=typeof model&&(model=function(){if(this.$data=_model,this.$key=options.$key,"object"==modelType)for(var a in _model)this[a]=_model[a]}),model.prototype.$set=function(a,b){for(var c=this,d=0,e=a.split("."),f=e.length,g=e.slice(-1)[0];f-1>d;d++){if(!c)return;c=c[e[d]]}if("function"==typeof c[g]){var h=slice.call(arguments,1,arguments.length);return"array"==$.type(c)?Array.prototype[g].apply(c,h):c[g].apply(null,h),void self.apply(e.splice(0,f-1).join("."))}c[g]=b,self.apply(a)},this.model=new model(this);var parent=this.options.$parent||this;this.model.$parent=parent.model,this.model.$parentScope=parent,this.domID={};var clicks=$el.find("[nj-click]");clicks.each(function(){var str=$(this).attr("nj-click");this.onclick=function(e){e=e||window.event;var $$data=syntaxInitialize(this,str,self),watchKey=$$data.watchKey;with(self.model.$event=e,self.model)try{eval("("+$$data.str+")")}catch(e){throw Error(e)}return watchKey.forEach(function(a){if("string"==typeof a)return void self.apply(a);var b=a.scope;a.key.forEach(function(a){b.apply(a)})}),!1}}),this.getSubscriber(el);for(var i in this.subscriber)this.apply(i)}var $=require("lib/jquery/jquery"),slice=Array.prototype.slice,validNode=/{{\s*([\$\w\.\+\-\*\/\%\!:\?\d''""<>&\(\),\s=#]+)\s*}}/,validNodes=/{{\s*([\$\w\.\+\-\*\/\%\!:\?\d''""<>&\(\),\s=#]+)\s*}}/g,$keywords=["this","return","true","false","var","for","delete","function","if"],ie8=$.browser.msie&&parseInt($.browser.version)<=8,noopMethod=function(){return function(){}};$data.cache={},$data.set=function(a,b,c){var d=+new Date+""+parseInt(1e4*Math.random());$data.cache[d]={node:a,key:b,value:c}},$data.get=function(a,b){for(var c in $data.cache)if($data.cache[c].node===a&&$data.cache[c].key===b)return $data.cache[c].value};var $specialAttrs=["style","checked","disabled","readonly","multiple","selected"];return Module.prototype={createModel:function(a){function b(a){a=a||window.event;var b=this,d=a.keyCode;(void 0==d||8==d||32==d||229==d||d>47&&58>d||d>64&&91>d||d>95&&112>d||d>185&&193>d||d>218&&223>d)&&setTimeout(function(){var a=b[i?"checked":"value"];if(j){var d=b.selectedOptions||function(){var a=[];return nodeToArray(b.options).forEach(function(b){b.selected&&a.push(b)}),a}(),e=slice.call(d,0).map(function(a){return a.$data||a.value});a=b.multiple?e:e[0]}new Function("a","b","a."+l+"=b;if(a.$data){a.$data."+l+"=b}")(c.model,a),c.apply(f,b)},0)}if(!$data(a,"$modelBind")){var c=this,d=a.tagName.toLowerCase(),e=/input|select|textarea/.test(d),f=$(a).attr("nj-item"),g=+new Date,h={id:g,element:a,key:f};if($data(a,"$modelBind",1),this.domID[g]=a,e){this.pushSubscriber(a,f,{writeAll:!0}),a.$scope=this.model;var i="checkbox"==a.type,j=/^select/.test(a.type),k=i||j?"change":"keydown",l=f;if("radio"==a.type)a.checked&&new Function("a","b","a."+l+"=b")(c.model,a.value),k="change";else if(j){var m=a.value||a.options[0].value;a.value=m,new Function("a","b","a."+l+"=b")(c.model,m)}$(a).on(k,b),"text"==a.type&&($.browser.msie?a.onpropertychange=b:a.addEventListener("input",b,!1))}return h}},getSubscriber:function(a,b){a=a||this.element,b=b||this.model;var c=this,d=getAllChildren(a,{filter:function(a){return c.getValidSubscribe(a)}});d.forEach(function(a){var b=[],d=a.value||a.nodeValue;d.replace(validNodes,function(a,c){c&&b.indexOf(c)<0&&b.push(c)}),c.pushSubscriber(a,b)})},getValidSubscribe:function(node){if(!node)return[];var self=this,subNodes=[],type=node.nodeType,elementNode=1==type;if($data(node,"$filter")||elementNode&&/script|style/.test(node.tagName.toLowerCase()))return subNodes;if($data(node,"$filter",1),1==type){node.getAttribute("nj-item")&&self.createModel(node);var njEach=elementNode&&node.getAttribute("nj-each");if(njEach){var eachData=/^\s*([\$\w\|\s:'"]+)\s*$/.exec(njEach);if(!eachData)return subNodes;eachData=eachData[1].split("|"),eachData.forEach(function(a,b){return eachData[b]=a=$.trim(a),a?(a=a.split(":"),void(a[1]&&/^[\w\$]+$/.test(a[1])&&$keywords.indexOf(a[1])<0&&(void 0===getAttribute(self.model,a[1])&&new Function("a","a."+a[1]+"=undefined")(self.model,a[1]),self.pushSubscriber(null,a[b],{action:{name:a[0],key:eachData[0]}})))):void eachData.splice(b,1)});var options=eachData.slice(1,eachData.length).join(",");if(options){var $$options="({"+options+"})";with(this.model)try{$$options=eval($$options)}catch(e){$$options={}}options=$$options}var templete=options.repeat?[node]:nodeToArray(node.childNodes),notes=document.createComment(eachData[0]+" each");if(templete.push(notes),getAllChildren(node).forEach(function(a){$data(a,"$filter",1)}),templete=templete.map(function(a){var b=a.cloneNode(!0);return options.repeat&&1==b.nodeType&&b.removeAttribute("nj-each"),b}),node.$each={templete:templete,options:options,parentNode:node.parentNode,nextSibling:node.nextSibling,models:[]},self.pushSubscriber(node,eachData[0]),options.repeat)return node.parentNode.removeChild(node),subNodes;node.innerHTML=""}nodeToArray(node.attributes).forEach(function(a){validNode.test(a.value)&&($data(a,"$parentElement",node),subNodes.push(a))})}else if(3==type){var html=$.trim(node.nodeValue);validNode.test(html)&&("textarea"==node.parentNode.type&&(node=node.parentNode),subNodes.push(node))}return subNodes},pushSubscriber:function(a,b,c){function d(b){if(!(/^\d+$/.test(b)||$keywords.indexOf(b)>=0)){b.replace(h,function(c,d){"parent"==d&&e.options.$parent.pushSubscriber(a,b.replace(h,""))}),e.subscriber[b]=e.subscriber[b]||[],c=$.extend({node:a,value:f,vars:j||[b]},c),e.subscriber[b].push(c)}}if(b){var e=this,f=a&&(a.value||a.nodeValue),g=$.type(b),h=/^\$(data|parent|root)\./;if("string"==g||c&&c.writeAll)return void d(b,"string");"array"==$.type(b)&&(b=b.join(";"));var i=syntaxInitialize(a,b,this),j=i?i.vars:[],k=i?i.methods:[];j.forEach(d,"vars"),k.forEach(function(a){var b;try{b=new Function("a","return a."+a)(e.model)}catch(c){b=new Function("a","return a."+a)(window)}if("function"==typeof b&&(b=b.toString(),!/^function[\s\w\(\)]+{ \[native code\] }/.test(b))){b=b.replace(/(?:^function\s*\([^\)]*\){)|(?:}$)/g,""),b=$.trim(b).replace(/[\r\n]/g,";");var f=syntaxParse(b,e).vars;f.forEach(function(a){d(a,"methods")})}})}},apply:function(a,b){if(a&&"function"!=a&&this.model){var c=this,d=this.subscriber[a]||[],e=getAttribute(this.model,a),f=/array|object/.test($.type(e));for(var g in this.subscriber)0==g.indexOf(a+".")&&this.apply(g,b);d.length&&(void 0!==this.model.$key&&this.model.$parentScope!==this&&a.indexOf("$")<0&&b&&this.model.$parentScope.apply(this.options.$arrayName,b),d.forEach(function(d){if(d.action)return void c.arrayOrder(e,d.action);var g=d.node;g!==b&&"radio"!=g.type&&c.updateNode(d,a,e,f)}))}},updateNode:function(item,key,value,isArray){var self=this,node=item.node,value;if(value=value||getAttribute(this.model,key),isArray=isArray||/array|object/.test($.type(value)),/^select/.test(node.type))return void self.defaultSelected(node);if(isArray&&node.$each)return void self.applyArray(node,key);var type=node.nodeType;if(item.writeAll)node.value=value;else{var text=item.value||node.value,reg;if(!text)return;var $val;if(text.replace(validNodes,function(a,b){var scope=node.$scope||self.model;with(reg=eval("/{{\\s*"+b.replace(/([\$\.\/\+\-\*\/\%\?:\(\),])/g,"\\$1")+"\\s*}}/g"),scope)$val=eval("("+b+")");void 0!==$val&&(text=text.replace(reg,$val))}),2==type){var attrName=node.name.replace(/^nj-/,""),parentNode=$data(node,"$parentElement")||node.ownerElement;if("style"!=attrName)return void(parentNode[attrName]=$val?!0:!1);var css=text.split(";");css.forEach(function(a){a=$.trim(a).split(":");var b=a[0],c=a[1];b&&(parentNode.style[b]=c)})}node[1==type||2==type?"value":"nodeValue"]=text}},applyArray:function(a,b,c){function d(a,c,d){var e=[];l.forEach(function(b){var c=b.cloneNode(!0);d.appendChild(c),e.push(c),1==c.nodeType&&"option"==c.tagName.toLowerCase()&&(c.$data=a)}),h.models.splice("array"==k?c:h.models.length,0,new Module(e,a,{$key:"array"==k?parseInt(c):c,$parent:g,$arrayName:b}))}if(a.$each){var e,f,g=this,h=a.$each,i=a,j=g.model[b],k=$.type(j),l=h.templete,m=h.models.length;if(h.options.repeat&&(i=h.parentNode),/^select|optgroup|option/.test(a.tagName.toLowerCase())&&i.type&&(e=i),m){if("order"==c){var n=i.childNodes;n=n[n.length-1];var o=h.models[m-1].element;o=o[o.length-1];var p=n===o?"appendChild":"insertBefore"}if("object"==k){for(var b,q=[],r=0;m>r;r++)if(f=h.models[r],b=f.model.$key,void 0!==j[b])q.push(b);else{h.models.splice(r,1);var s=f.element;console.log(s),s.forEach(function(a){i.removeChild(a)}),r--,m--}for(var r in j)if(q.indexOf(r)<0){var t=document.createDocumentFragment();d(j[r],r,t),i.insertBefore(t,a.childNodes[l.length*m])}return void(e&&g.defaultSelected(e))}for(var u=j.length>m,v=Math.max(j.length,m),r=0;v>r;r++)if(f=h.models[r])if(f.model.$key!=r&&(f.model.$key=r,f.apply("$key")),f.model.$data!==j[r])if(u){var t=document.createDocumentFragment();d(j[r],r,t),i.insertBefore(t,f.element[0])}else if("order"==c){h.models.splice(r,1),h.models.push(f);var w=f.element;w.forEach(function(a){i[p](a,n)}),r--}else{h.models.splice(r,1);var s=f.element;s.forEach(function(a){i.removeChild(a)}),r--,v--}else{if("object"==$.type(j[r]))for(var x in j[r])f.model[x]=j[r][x];for(var y in f.subscriber)f.apply(y)}else{var t=document.createDocumentFragment();d(j[r],r,t),f=h.models[r-1];var z=f.element[f.element.length-1];z.nextSibling?i.insertBefore(t,z.nextSibling):i.appendChild(t)}return void(e&&g.defaultSelected(e))}if("order"!=c){var t=document.createDocumentFragment();for(var r in j)!Array.prototype[r]&&d(j[r],r,t);h.options.repeat?h.nextSibling?i.insertBefore(t,h.nextSibling):i.appendChild(t):a.appendChild(t),e&&g.defaultSelected(e)}}},arrayOrder:function(a,b){for(var c,d=this,e=b.key,f=new Function("a","return a."+e)(this.model),g=f.map(function(b){return new Function("a","return a."+a)(b)}).sort(),h=0,i=f.length;i>h;h++)c=f[h],new Function("a","return a."+a)(c)!==g[h]&&(f.splice(h,1),f.push(c),h--);var j=this.subscriber[e]||[];j.forEach(function(a){var b=a.node;b.$each?d.applyArray(b,e,"order"):d.updateNode(a,e)})},defaultSelected:function(node){var $$sel=node.getAttribute("nj-item");with(this.model)$$sel="undefined"==eval("typeof "+$$sel)?void 0:eval($$sel);if($$sel){var selected="array"==$.type($$sel)?$$sel:[$$sel];nodeToArray(node.options).forEach(function(a){a.$data&&(a.selected=selected.indexOf(a.$data)>=0&&!0)})}}},{module:function(a,b){var c=$(document.body).find('[nj-module="'+a+'"]')[0];return new Module(c,b).model}}});