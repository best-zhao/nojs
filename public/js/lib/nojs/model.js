/*nolure@vip.qq.com*/define("lib/nojs/model",["lib/jquery/jquery"],function(require){function syntaxParse(str,scope){function checkArgument(a){return a=$.trim(a),!a||reStr[a]||/^(\d+|this|return|true|false|var|for|delete)$/.test(a)||/^(\d|[^\w\$])/.test(a)?!1:!0}function initMethod(a,b){if("$key"!=a){var c=model,d=a.split("."),e=d[0],f=$.trim(d.slice(-1)[0]);if(!b&&e&&!/^(\$(?:key|data)\.)/.test(e+".")&&watchKey.indexOf(e)<0&&watchKey.push(e),void 0!==c[e]||void 0===window[e])for(var g,h=0,i=d.length,j=scope,k=0;i>h&&(g=$.trim(d[h]),g&&!/^true|false&/.test(g));h++){if(("$parent"==g||"$root"==g)&&(j=c[g+"Scope"],k=h+1),void 0!==c[g]){if(b&&h==i-2&&Array.prototype[f]&&"array"==$.type(c[g])){var l=d.slice(k,i-1).join(".");l=l?[l]:[];for(var m in j.subscriber)0==m.indexOf(l[0]+".")&&l.push(m);l.length&&watchKey.push({scope:j,key:l});break}}else c[g]=g!=f||b?noopMethod():void 0;c=c[g]}}}var model=scope.model,reStr={},data={watchKey:[],methods:[],vars:[]},watchKey=data.watchKey,methods=data.methods,vars=data.vars,skey="_nj_str_",akey="nj_arg_",n=0;str=str.replace(/"(?:\\"|[^"])*"|'(?:\\'|[^'])*'/g,function(a){if(a){var b=skey+ ++n;return reStr[b]=a,b}}),str=str.replace(/\)\s*{[\w\W]*}/g,")"),str.replace(/([\$\w\.\+\-\*\/\%\!:\?]+)\s*\(/g,function(a,b){methods.indexOf(b)<0&&methods.push(b)}),str=str.replace(/\(([\s\w\$\(\),\.\+\-\*\/\%\!:\?=]*)\)/g,function(a,b){b=b.split(/[,\+\-\*\/\%\!:\?=]/),b.forEach(function(a){a=a.replace(/^\(|\)$/,""),a.indexOf("(")>0&&(a=a.split("("),methods.indexOf(a[0])<0&&methods.push(a[0]),a=a[1]),a=$.trim(a),checkArgument(a)&&vars.indexOf(a)<0&&vars.push(a)});var c=";"+akey+ ++n+";";return reStr[c]=a,c}),str=str.split(";");var regCompute=/[\+\-\*\/%\!=\?:<>\s]/,validStr=/[\$\w\.\+\-\*\/%\!=\?:<>]+/,keyword=/^(\$(?:parent|root)\.)/;str.forEach(function(a,b){if(str[b]=a=$.trim(a),a&&!reStr[";"+a+";"]&&validStr.test(a)&&!(methods.indexOf(a)>=0&&reStr[";"+str[b+1]+";"])){var c=a.split(regCompute);c.forEach(function(a){a=$.trim(a),checkArgument(a)&&vars.indexOf(a)<0&&methods.indexOf(a)<0&&vars.push(a)})}}),methods.forEach(function(a){initMethod(a,!0)});for(var i=0,n=vars.length,name;n>i;i++)name=vars[i]=vars[i].replace(/^this\./,""),checkArgument(name)?initMethod(name):(vars.splice(i,1),i--,n--);str=str.join(";");for(var i in reStr)str=str.replace(eval("/"+i+"/g"),reStr[i]);return data.str=str,data}function syntaxInitialize(a,b,c){return a&&b?a.$syntax?a.$syntax:a.$syntax=syntaxParse(b,c):void 0}function getAllChildren(a,b){function c(a){if(a&&a.length)for(var b,e=0,f=a.length;f>e;e++)b=a[e],d(b),b&&1==b.nodeType&&c(b.childNodes)}function d(a){if(b.filter){var c=b.filter(a);c&&(e=e.concat(c))}else e.push(a)}b=b||{};var e=[];return a?(b.andSelf&&d(a),c("array"==$.type(a)?a:a.childNodes),e):e}function Module(el,model,options){this.element=el;var $el=$(el);this.options=options=options||{},this.models=[],this.subscriber={};var self=this,_model=model,modelType=$.type(model);"function"!=typeof model&&(model=function(){if(this.$data=_model,this.$key=options.$key,"object"==modelType)for(var a in _model)this[a]=_model[a]}),model.prototype.$set=function(a,b){for(var c=this,d=0,e=a.split("."),f=e.length,g=e.slice(-1);f-1>d;d++){if(!c)return;c=c[e[d]]}if("function"==typeof c[g]){var h=slice.call(arguments,1,arguments.length);return"array"==$.type(c)?Array.prototype[g].apply(c,h):c[g].apply(null,h),void self.apply(e.splice(0,f-1).join("."))}c[g]=b,self.apply(a)},this.model=new model(this);var parent=this.options.$parent||this;this.model.$parent=parent.model,this.model.$parentScope=parent,this.domID={};var items=$el.find("[nj-item]");items.each(function(){self.models.push(self.createModel(this))});var clicks=$el.find("[nj-click]");clicks.each(function(){var str=$(this).attr("nj-click");this.onclick=function(e){var data=syntaxInitialize(this,str,self),watchKey=data.watchKey;with(self.model.$event=e,self.model)try{eval(this.$syntax.str)}catch(e){throw Error(e)}watchKey.forEach(function(a){if("string"==typeof a)return void self.apply(a);var b=a.scope;a.key.forEach(function(a){b.apply(a)})}),e.preventDefault()}}),this.getSubscriber(el);for(var i in this.subscriber)this.apply(i)}var $=require("lib/jquery/jquery"),slice=Array.prototype.slice,validNode=/{{\s*([\$\w\.\+\-\*\/\%\!:\?\d''""<>&\(\),\s=#]+)\s*}}/,validNodes=/{{\s*([\$\w\.\+\-\*\/\%\!:\?\d''""<>&\(\),\s=#]+)\s*}}/g,noopMethod=function(){return function(){}};return Module.prototype={createModel:function(el){if(!el.$modelBind){var self=this,tagName=el.tagName.toLowerCase(),isFormElement=/input|select|textarea/.test(tagName),key=$(el).attr("nj-item"),id=+new Date,model={id:id,element:el,key:key};if(el.$modelBind=1,this.domID[id]=el,isFormElement){this.pushSubscriber(el,key,{writeAll:!0}),el.$scope=this.model;var checkbox="checkbox"==el.type,selectNode=/^select|optgroup/.test(el.type),eventName=checkbox||selectNode?"change":"keydown",_key=key;if("radio"==el.type){if(el.checked)with(self.model)eval(_key+'="'+el.value+'"');eventName="change"}else if(selectNode)var selectVal=el.value||el.options[0].value;$(el).on(eventName,function(){var v=this;if(selectNode&&v.$selectedKey){var $selectedOptions=slice.call(v.selectedOptions,0).map(function(a){return a.index});with(self.model)eval(v.$selectedKey+"=["+$selectedOptions+"]")}setTimeout(function(){var val=v[checkbox?"checked":"value"];with(self.model)eval(checkbox?_key+"="+val:_key+'="'+val+'"'),self.model.$data&&($data[_key]=val);self.apply(key,v)},0)})}return model}},getSubscriber:function(a,b){a=a||this.element,b=b||this.model;var c=this,d=getAllChildren(a,{filter:function(a){return c.getValidSubscribe(a)}});d.forEach(function(a){var d=[],e=a.value||a.nodeValue;e.replace(validNodes,function(a,b){b&&d.indexOf(b)<0&&d.push(b)}),c.pushSubscriber(a,d),a.$scope=b})},getValidSubscribe:function(node){if(!node)return[];var self=this,subNodes=[],type=node.nodeType,elementNode=1==type;if(node.$filter||elementNode&&/script|style/.test(node.tagName.toLowerCase()))return subNodes;if(node.$filter=1,1==type){var njEach=elementNode&&node.getAttribute("nj-each");if(njEach){var eachData=/^\s*([\$\w\|\s:]+)\s*$/.exec(njEach);if(!eachData)return subNodes;eachData=eachData[1].split("|"),eachData.forEach(function(a,b){eachData[b]=a=$.trim(a),a||eachData.splice(b,1)});var options=eachData.slice(1,eachData.length).join(","),selectedKey,tagName;if(options){selectedKey=/(?:^|[,\|])selected\s*:\s*([\w\$]+)/.exec(options),selectedKey=selectedKey&&selectedKey[1];var $$options="({"+options+"})";with(this.model)try{$$options=eval($$options)}catch(e){throw Error(e)}if(options=$$options,options.selected&&selectedKey&&(node.$selected=selectedKey,this.pushSubscriber(node,selectedKey),tagName=node.tagName.toLowerCase(),"option"==tagName||"optgroup"==tagName||"select"==tagName)){var selectNode="select"!=tagName?node.parentNode:node;selectNode.$selectedOptions=options.selected,selectNode.$selectedKey=selectedKey;var startIndex="select"!=tagName&&options.repeat?node.index:0;selectNode.$startIndex=startIndex,self.createModel(selectNode)}}options=options||{};var templete=options.repeat?[node]:slice.call(node.childNodes,0),notes=document.createComment(eachData[0]+" each");if(templete.push(notes),getAllChildren(node).forEach(function(a){a.$filter=1}),node.$each={templete:templete,options:options,parentNode:node.parentNode,nextSibling:node.nextSibling,models:[]},self.pushSubscriber(node,eachData[0]),options.repeat)return node.parentNode.removeChild(node),node.removeAttribute("nj-each"),subNodes;node.innerHTML=""}var _attrs=node.attributes,attrs=[],n=_attrs.length,i;if(n){for(i=0;n>i;i++)attrs.push(_attrs[i]);attrs.forEach(function(a){validNode.test(a.value)&&(a.$parentElement=node,subNodes.push(a))})}}else if(3==type){var html=$.trim(node.nodeValue);validNode.test(html)&&("textarea"==node.parentNode.type&&(node=node.parentNode),subNodes.push(node))}return subNodes},pushSubscriber:function(node,key,data,subScope){function push(a){a.replace(rKey,function(b,c){"parent"==c&&self.options.$parent.pushSubscriber(node,a.replace(rKey,""))}),subScope[a]=subScope[a]||[],data=$.extend({node:node,value:value,vars:vars||[a]},data),subScope[a].push(data)}if(key){var self=this,value=node.value||node.nodeValue,_key=key,keyType=$.type(key),rKey=/^\$(data|parent|root)\./;if(subScope=subScope||this.subscriber,"string"==keyType||data&&data.writeAll)return void push(key);"array"==$.type(key)&&(key=key.join(";"));var d=syntaxInitialize(node,key,this),vars=d?d.vars:[],methods=d?d.methods:[];vars.forEach(push),methods.forEach(function(k){var fnStr;with(self.model)fnStr=eval(k);if("function"==typeof fnStr){fnStr=fnStr.toString().replace(/(?:^function\s*\(\){)|(?:}$)/g,""),fnStr=$.trim(fnStr).replace(/[\r\n]/g,";");var vars=syntaxParse(fnStr,self).vars;vars.forEach(function(a){push(a)})}})}},apply:function(key,notApply){if(key&&this.model){var self=this,subscriber=this.subscriber[key]||[],value=this.model[key];with(this.model)value="undefined"==eval("typeof "+key)?void 0:eval(key);var valueType=$.type(value),observableArray=/array|object/.test(valueType),_key=key.split(".");for(var i in this.subscriber)0==i.indexOf(key+".")&&this.apply(i);subscriber.length&&(void 0!==this.model.$key&&this.model.$parentScope!==this&&key.indexOf("$")<0&&notApply&&this.model.$parentScope.apply(this.options.$arrayName,notApply),subscriber.forEach(function(item){var node=item.node;if(node!==notApply&&"radio"!=node.type){if(observableArray&&node.$each)return void(node.$selected==key?self.defaultSelected(node):self.applyArray(node,key));var type=node.nodeType;if(item.writeAll)node.value=value;else{var text=item.value||node.value,reg;if(!text)return;var $val;if(text.replace(validNodes,function(a,b){var scope=node.$scope||self.model;with(reg=eval("/{{\\s*"+b.replace(/([\$\.\/\+\-\*\/\%\?:\(\),])/g,"\\$1")+"\\s*}}/g"),scope){$val=eval(b);try{}catch(e){}}void 0!==$val&&(text=text.replace(reg,$val))}),2==type){var attrName=node.name,parentNode;if(/checked|disabled|readonly|multiple|selected/.test(attrName))return parentNode=node.$parentElement,void parentNode[$val?"setAttribute":"removeAttribute"](attrName,attrName)}node[1==type||2==type?"value":"nodeValue"]=text}}}))}},applyArray:function(a,b){function c(a,c,d){var g=[];j.forEach(function(a){var b=a.cloneNode(!0);d.appendChild(b),g.push(b)}),f.models.splice("array"==i?c:f.models.length,0,new Module(g,a,{$key:"array"==i?parseInt(c):c,$parent:e,$arrayName:b}))}if(a.$each){var d,e=this,f=a.$each,g=a,h=e.model[b],i=$.type(h),j=f.templete,k=f.models.length;if(f.options.repeat&&(g=f.parentNode),k){if("object"==i){for(var b,l=[],m=0;k>m;m++)if(d=f.models[m],b=d.model.$key,void 0!==h[b])l.push(b);else{f.models.splice(m,1);var n=d.element;n.forEach(function(a){g.removeChild(a)}),m--,k--}for(var m in h)if(l.indexOf(m)<0){var o=document.createDocumentFragment();c(h[m],m,o),g.insertBefore(o,a.childNodes[j.length*k])}return void e.defaultSelected(a)}for(var p=h.length>k,q=Math.max(h.length,k),m=0;q>m;m++)if(d=f.models[m]){if(d.model.$key!=m&&(d.model.$key=m,d.apply("$key")),d.model.$data!==h[m])if(p){var o=document.createDocumentFragment();c(h[m],m,o),g.insertBefore(o,d.element[0])}else{f.models.splice(m,1);var n=d.element;n.forEach(function(a){g.removeChild(a)}),m--,q--}}else{var o=document.createDocumentFragment();c(h[m],m,o),d=f.models[m-1];var r=d.element[d.element.length-1];r.nextSibling?g.insertBefore(o,r.nextSibling):g.appendChild(o)}return void e.defaultSelected(a)}var o=document.createDocumentFragment();for(var m in h)c(h[m],m,o);f.options.repeat?f.nextSibling?g.insertBefore(o,f.nextSibling):g.appendChild(o):a.appendChild(o),e.defaultSelected(a)}},defaultSelected:function(a){var b=a.tagName.toLowerCase();if(/^select|optgroup|option/.test(b)){var c,d=a.$each,e=d.options.selected;if(e){c=a.type?a:a.parentNode,c=c.type?c:c.parentNode;var f=slice.call(c.options,0);f.length&&e.forEach(function(a){f[a].selected=!0})}}}},{module:function(a,b){var c=$(document.body).find('[nj-module="'+a+'"]')[0];return new Module(c,b).model}}});