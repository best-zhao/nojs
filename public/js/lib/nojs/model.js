/*nolure@vip.qq.com*/define("lib/nojs/model",["lib/jquery/jquery"],function(require){function syntaxParse(a,b){function c(a){return a=$.trim(a),!a||$keywords.indexOf(a)>=0||/^(\d|[^\w\$])/.test(a)?!1:!0}function d(a,b){var c;return h.forEach(function(d){d.key==a&&d.scope==b&&(c=!0)}),c}function e(a,c){if("$key"!=a){var e,g=f,i=a.split("."),j=i[0],k=$.trim(i.slice(-1)[0]),l=b;if(c||!j||/^(\$(?:key|data)\.)/.test(j+".")||(0==a.indexOf("$parent.")?(e=i.slice(1,i.length).join("."),l=f.$parentScope):e=j,d(e,l)||h.push({key:e,scope:l})),void 0!==g[j]||void 0===window[j]){var m,n=0,o=i.length,p=0;for(l=b;o>n&&(m=$.trim(i[n]),m&&!/^true|false&/.test(m));n++){if(("$parent"==m||"$root"==m)&&(l=g[m+"Scope"],p=n+1),void 0!==g[m]){if(c&&n==o-2&&Array.prototype[k]&&"array"==$.type(g[m])&&(e=i.slice(p,o-1).join("."),e&&!d(e,l))){h.push({scope:l,key:e});break}}else g[m]=m!=k||c?function(){}:void 0;g=g[m]}}}}var f=b.model,g={watchKey:[],methods:[],vars:[]},h=g.watchKey,i=g.methods,j=g.vars;return a.replace(/"(?:\\"|[^"])*"|'(?:\\'|[^'])*'|\/(?:\\\/|[^\/\r\n])+\/(?=[^\/])|((?:\$|\b)[\$\w\.]+)\b(\(?)/g,function(a,b,d){d?c(b)&&i.indexOf(b)<0&&i.push(b):b&&c(b)&&j.indexOf(b)<0&&j.push(b)}),i.forEach(function(a){e(a,!0)}),j.forEach(function(a){e(a)}),g}function syntaxInitialize(a,b,c){if(a&&b){var d=$data(a,"$syntax");return d?d:(d=syntaxParse(b,c),$data(a,"$syntax",d),d)}}function getAllChildren(a,b){function c(a){if(a&&a.length)for(var b,e=0,f=a.length;f>e;e++)b=a[e],d(b),b&&1==b.nodeType&&c(b.childNodes)}function d(a){if(b.filter){var c=b.filter(a);c&&(e=e.concat(c))}else e.push(a)}b=b||{};var e=[];return a?(b.andSelf&&d(a),c("array"==$.type(a)?a:a.childNodes),e):e}function $data(a,b,c){return"undefined"==typeof c?ie8?$data.get(a,b):a[b]:void(ie8?$data.set(a,b,c):a[b]=c)}function nodeToArray(a){return ie8?function(){for(var b=[],c=0,d=a.length;d>c;c++)b.push(a[c]);return b}():slice.call(a,0)}function getAttribute(a,b,c){c=c===!1?!1:!0;var d=["var value;","try{","value = a."+b,"}catch(e){","if(b){ value = window."+b+" }","}","return value;"].join("");return new Function("a","b",d)(a,c)}function getFnVars(a){var b=[];if("function"!=typeof a)return b;var c=a.toString();return/^function[\s\w\(\)]+{[\s\n]*\[native code\][\s\n]*}/.test(c)?b:(c=c.replace(/(?:^function\s*\([^\)]*\){)|(?:}$)/g,""),c.replace(/"(?:\\"|[^"])*"|'(?:\\'|[^'])*'|\/\*[\S\s]*?\*\/|\/(?:\\\/|[^\/\r\n])+\/(?=[^\/])|\/\/.*|[^\w]\$scope\.([\$\w\.]+)\b/g,function(a,c){c&&b.indexOf(c)<0&&b.push(c)}),b)}function getDifferents(a,b,c){var d,e=c||$.type(a),f={state:!0,items:[]};if(!/array|object|function/.test(e)||null===a||void 0===a)return f.state=a===b,f;if($.type(b)!=e)return f.state=!1,f;var g,h,i,j,k;for(g in a)if(j=g,h=a[g],i=b[g],e=$.type(h),"function"!=e)if(/array|object|function/.test(e)){if(d="array"==e,d&&h.length!=i.length){f.state=!1,f.items.push(j);continue}j=d?"":g+".",k=getDifferents(h,i,e),k.state||(f.state=!1,k.items.forEach(function(a){f.items.push(j+a)}))}else h!==i&&(f.state=!1,f.items.push(j));return f}function Controller(el,model,options){this.element=el,this.options=options=options||{},this.subscriber={},this.cache={},this.cacheTimer=null,this.dependences={};var self=this,modelType=$.type(model),Model;Model="function"!=modelType?function(){if(model&&(this.$data=model,this.$key=options.$key,"object"==modelType))for(var a in model)this[a]=model[a]}:function(){var a=this,b=model.toString().match(/^function\s*\(([\w\$,\s]+)\)/),c=self.options.name,d=[];b=b&&b[1].split(","),b=b?b.map(function(b){if(b=$.trim(b),"$scope"==b)return a;var e=Module.get(b,{scope:self,name:c});return e?(d.push(e),e.value):void 0}):[],model.apply(null,b);var e,f,g,h,i,j=d.length,k=0;for(e in a){for(g=a[e],f=0;j>f;f++)if(i=d[f],i.value===g){i.subscriber[c].key=e,h||(self.dependences[e]=i.modeName),delete i._value,k++;break}if(k==j)break;h=1}},Model.prototype.$set=function(a,b){for(var c=this,d=0,e=a.split("."),f=e.length,g=e.slice(-1)[0];f-1>d;d++){if(!c)return;c=c[e[d]]}if("function"==typeof c[g]){var h=slice.call(arguments,1,arguments.length);"array"==$.type(c)?Array.prototype[g].apply(c,h):c[g].apply(null,h),self.apply(e.splice(0,f-1).join("."))}else c[g]=b,self.apply(a)},this.model=new Model;var parent=this.options.$parent;parent&&(this.model.$parent=parent.model,this.model.$parentScope=parent),this.models={};var $el=$(el),clicks=$el.find("["+_config.click+"]");clicks.each(function(){var str=$(this).attr(_config.click);this.onclick=function(e){e=e||window.event;var $$data=syntaxInitialize(this,str,self),watchKey=$$data.watchKey;with(self.model.$event=e,self.model){eval("("+str+")");try{}catch(e){}}var keys=watchKey.map(function(a){return a.key});return $$data.methods.forEach(function(a){var b=0==a.indexOf("$parent.")?self.model.$parentScope:self;getFnVars(getAttribute(self.model,a,!1)).forEach(function(a){var c=a.split(".");if(c.length>1){var d=c.slice(0,c.length-1).join(".");c="array"==$.type(getAttribute(self.model,d,!1))&&Array.prototype[c.slice(-1)[0]]?d:c.join(".")}else c=a;keys.indexOf(c)<0&&(watchKey.push({key:c,scope:b}),keys.push(c))})}),watchKey.forEach(function(a){a.scope.apply(a.key)}),!1}}),this.getSubscriber(el);for(var i in this.subscriber)this.apply(i);this.ready=!0}function Module(a,b){Module.items[a]={value:"function"==typeof b?b():b,subscriber:{},modeName:a}}var $=require("lib/jquery/jquery"),slice=Array.prototype.slice,$keywords=["this","return","true","false","var","for","delete","function","if"],ie8=$.browser.msie&&parseInt($.browser.version)<=8,_config={startSymbol:"{{",endSymbol:"}}",controller:"nj-module",model:"nj-item",each:"nj-each",click:"nj-click"},validReg=_config.startSymbol+"\\s*([\\w\\W]+?)\\s*"+_config.endSymbol,validNode=new RegExp(validReg),validNodes=new RegExp(validReg,"g");$data.cache={},$data.set=function(a,b,c){if(null===c)for(var d in $data.cache)if($data.cache[d].node===a&&$data.cache[d].key===b)return void delete $data.cache[d];var e=+new Date+""+parseInt(1e4*Math.random());$data.cache[e]={node:a,key:b,value:c}},$data.get=function(a,b){for(var c in $data.cache)if($data.cache[c].node===a&&$data.cache[c].key===b)return $data.cache[c].value};var $specialAttrs=["href","style","checked","disabled","readonly","multiple","selected"];Controller.prototype={createModel:function(a,b){function c(c){c=c||window.event;var e=this,f=c.keyCode;(void 0==f||8==f||32==f||229==f||f>47&&58>f||f>64&&91>f||f>95&&112>f||f>185&&193>f||f>218&&223>f)&&setTimeout(function(){var f=e.value;if(i){var g=e.selectedOptions||function(){var a=[];return nodeToArray(e.options).forEach(function(b){b.selected&&a.push(b)}),a}(),j=slice.call(g,0).map(function(a){return a.$data||a.value});f=e.multiple?j:j[0]}else if(h&&d.models[b].group){var k=[];d.models[b].forEach(function(a){a.checked&&k.push(a.value)}),f=k}new Function("a","b","a."+b+"=b;if(a.$data){a.$data."+b+"=b}")(d.model,f),d.apply(b,e);var l=b.split(".");l.push("change");var m=d.model[l.join("_")];m&&m.call(a,c)},0)}if(!$data(a,"$modelBind")){var d=this,e=a.tagName.toLowerCase(),f=/input|select|textarea/.test(e);if($data(a,"$modelBind",1),f){this.pushSubscriber(a,b,{writeAll:!0}),$data(a,"$scope",this.model);var g=a.type,h="checkbox"==g,i=/^select/.test(g),j=h||i||"radio"==g?"change":"input",k=getAttribute(d.model,b);if(!this.models[b]){var l=[];l.nodeType=g,this.models[b]=l}if(this.models[b].push(a),"text"==g&&void 0===k&&new Function("a","b","a."+b+"=b")(d.model,""),h){var m=$.type(k);this.models[b].group="array"==m&&!0,this.models[b].length>1&&(this.models[b].group=!0,void 0==k?k=[]:"array"!=m&&(k=[k]),new Function("a","b","a."+b+"=b")(d.model,k)),m=$.type(k),a.checked?("array"==m?k.push(a.value):k=a.value,new Function("a","b","a."+b+"=b")(d.model,k)):(k==a.value||"array"==m&&k.indexOf(a.value)>=0)&&(a.checked=!0)}else if("radio"==g)k==a.value?a.checked=!0:a.checked&&!k&&new Function("a","b","a."+b+"=b")(d.model,a.value);else if(i&&!$data(a,"$eachNode")){var n=a.value||a.options[0].value;a.value=n,new Function("a","b","a."+b+"=b")(d.model,n)}"text"==g&&ie8&&(j="keydown"),$(a).on(j,c)}}},getSubscriber:function(a,b){a=a||this.element,b=b||this.model;var c=this,d=getAllChildren(a,{filter:function(a){var b=c.getValidSubscribe(a);if(a&&1==a.nodeType){var d=a.getAttribute(_config.model);d&&c.createModel(a,d)}return b}});d.forEach(function(a){var d=[],e=a.value||a.nodeValue;"textarea"==a.type&&(e=a.innerHTML),e.replace(validNodes,function(a,b){b&&d.indexOf(b)<0&&d.push(b)}),c.pushSubscriber(a,d),$data(a,"$scope",b)})},getValidSubscribe:function(node){if(!node)return[];var self=this,subNodes=[],type=node.nodeType,elementNode=1==type;if($data(node,"$filter")||elementNode&&/script|style/.test(node.tagName.toLowerCase()))return subNodes;if($data(node,"$filter",1),1==type){var njEach=elementNode&&node.getAttribute(_config.each);if(njEach){var eachData=/^\s*([\$\w\|\s:'"]+)\s*$/.exec(njEach);if(!eachData)return subNodes;eachData=eachData[1].split("|"),eachData.forEach(function(a,b){return eachData[b]=a=$.trim(a),a?(a=a.split(":"),void(a[1]&&/^[\w\$]+$/.test(a[1])&&$keywords.indexOf(a[1])<0&&(void 0===getAttribute(self.model,a[1])&&new Function("a","a."+a[1]+"=undefined")(self.model,a[1]),self.pushSubscriber(null,a[b],{action:{name:a[0],key:eachData[0]}})))):void eachData.splice(b,1)});var options=eachData.slice(1,eachData.length).join(",");if(options){var $$options="({"+options+"})";with(this.model)try{$$options=eval($$options)}catch(e){$$options={}}options=$$options}else options={};var templete=options.repeat?[node]:nodeToArray(node.childNodes),notes=document.createComment(eachData[0]+" each");if(templete.push(notes),getAllChildren(node).forEach(function(a){$data(a,"$filter",1)}),templete=templete.map(function(a){var b=a.cloneNode(!0);return options.repeat&&1==b.nodeType&&b.removeAttribute(_config.each),b}),$data(options.repeat?node.parentNode:node,"$eachNode",1),node.$each={templete:templete,options:options,parentNode:node.parentNode,nextSibling:node.nextSibling,models:[],arrayKey:eachData[0]},self.pushSubscriber(node,eachData[0]),options.repeat)return node.parentNode.removeChild(node),subNodes;node.innerHTML=""}nodeToArray(node.attributes).forEach(function(a){validNode.test(a.value)&&($data(a,"$parentElement",node),subNodes.push(a))})}else if(3==type){var html=$.trim(node.nodeValue);validNode.test(html)&&("textarea"==node.parentNode.type&&(node=node.parentNode),subNodes.push(node))}return subNodes},pushSubscriber:function(a,b,c){function d(b){if(!(/^\d+$/.test(b)||$keywords.indexOf(b)>=0)){if(h.test(b))return void e.options.$parent.pushSubscriber(a,b.replace(h,""));var d=e.subscriber[b]=e.subscriber[b]||[],g=d.map(function(a){return a.node});g.indexOf(a)>=0||(c=$.extend({node:a,value:f,vars:j||[b]},c),d.push(c))}}if(b){var e=this,f=a&&(a.value||a.nodeValue),g=$.type(b),h=/^\$(parent|root)\./;if(a&&"textarea"==a.type&&(f=a.innerHTML),"string"==g||c&&c.writeAll)return void d(b,"string");"array"==$.type(b)&&(b=b.join(";"));var i=syntaxInitialize(a,b,this),j=i?i.vars:[],k=i?i.methods:[];j.forEach(d),k.forEach(function(a){var b=getAttribute(e.model,a,!1),c=getFnVars(b);c.forEach(function(a){var b=getAttribute(e.model,a,!1);void 0!==b&&d(a)})})}},apply:function(a,b){if(a&&"function"!=a&&this.model){var c=this,d=this.subscriber[a]||[],e=getAttribute(this.model,a,!1),f=$.type(e),g=/array|object/.test(f);for(var h in this.subscriber)0==h.indexOf(a+".")&&this.apply(h,b);if(void 0===this.cache[a])this.cache[a]={key:a,value:g?$.extend(!0,"array"==f?[]:{},e):e},setTimeout(function(){delete c.cache[a]},10);else{var i=getDifferents(e,this.cache[a].value,f);if(i.state)return}var j=a.split("."),k=this.dependences;if(j.length>1&&"once"!=b){j=j.slice(1,j.length).join(".");for(var h in k)if(0==a.indexOf(h+".")){exports.$set(k[h]+"."+j,e,c.options.name);break}}d.length&&(void 0!==this.model.$key&&this.model.$parentScope!==this&&a.indexOf("$")<0&&b&&this.model.$parentScope.apply(this.options.$arrayName,b),this.ready&&!b&&this.models[a]&&this.models[a].forEach(function(a){(a.value==e||"array"==f&&e.indexOf(a.value)>=0)&&(a.checked=!0)}),d.forEach(function(d){if(d.action&&"orderBy"==d.action.name)return void c.arrayOrder(e,d.action);var f=d.node;f!==b&&"radio"!=f.type&&"checkbox"!=f.type&&c.updateNode(d,a,e,g)}))}},updateNode:function(item,key,value,isArray){var self=this,node=item.node,value,valueType;if(!$data(node,"$latest")){if(value=value||getAttribute(this.model,key),valueType=$.type(value),isArray=isArray||/array|object/.test(valueType),isArray&&node.$each&&node.$each.arrayKey==key)return void self.applyArray(node,key);if(/^select/.test(node.type))return void self.defaultSelected(node);$data(node,"$latest",1),setTimeout(function(){$data(node,"$latest",null)},0);var type=node.nodeType;if(!item.writeAll){var text=item.value||node.value,reg;if(!text)return;$data(node,"$nj_init",1);var $val,scope=$data(node,"$scope")||self.model;text.replace(validNodes,function(a,b){with(reg=eval("/{{\\s*"+b.replace(/([\$\.\/\+\-\*\/\%\?:\(\),\[\]])/g,"\\$1")+"\\s*}}/g"),scope)$val=eval("("+b+")");text=text.replace(reg,void 0===$val?"":$val)});var attrName=node.name;if(2==type&&/^nj-/.test(attrName)){attrName=node.name.replace(/^nj-/,"");var parentNode=$data(node,"$parentElement")||node.ownerElement;if("style"!=attrName)return void(parentNode[attrName]=$val?!0:!1);var css=text.split(";");css.forEach(function(a){a=$.trim(a).split(":");var b=a[0],c=a[1];b&&(parentNode.style[b]=c)})}return"textarea"==node.type&&(node.innerHTML=text),void(node[1==type||2==type?"value":"nodeValue"]=text)}node.value=value}},applyArray:function(a,b,c){function d(a,c,d){var e=[];l.forEach(function(b){var c=b.cloneNode(!0);d.appendChild(c),e.push(c),1==c.nodeType&&"option"==c.tagName.toLowerCase()&&(c.$data=a)}),h.models.splice("array"==k?c:h.models.length,0,new Controller(e,a,{$key:"array"==k?parseInt(c):c,$parent:g,$arrayName:b}))}if(a.$each){c=c||{};var e,f,g=this,h=a.$each,i=a,j=g.model[b],k=$.type(j),l=h.templete,m=h.models.length,n=c.action;if(h.options.repeat&&(i=h.parentNode),/^select|optgroup|option/.test(a.tagName.toLowerCase())&&i.type&&(e=i),m){if("order"==n){var o=i.childNodes;o=o[o.length-1];var p=h.models[m-1].element;p=p[p.length-1];var q=o===p?"appendChild":"insertBefore"}if("object"==k){for(var b,r=[],s=0;m>s;s++)if(f=h.models[s],b=f.model.$key,void 0!==j[b])r.push(b);else{h.models.splice(s,1);var t=f.element;t.forEach(function(a){i.removeChild(a)}),s--,m--}m=h.models.length;for(var s in j)if(r.indexOf(s)<0){var u=document.createDocumentFragment();d(j[s],s,u);var v=a.childNodes[l.length*m-1];i[v.nextSibling?"insertBefore":"appendChild"](u,v.nextSibling)}if("order"==n)for(var s=0;m>s;s++)if(f=h.models[s],f.model.$data!==c._array[s].value){h.models.splice(s,1),h.models.push(f);var w=f.element;w.forEach(function(a){i[q](a,o)}),s--}return void(e&&g.defaultSelected(e))}for(var x=j.length>m,y=Math.max(j.length,m),s=0;y>s;s++)if(f=h.models[s])if(f.model.$key!=s&&(f.model.$key=s,f.apply("$key")),f.model.$data!==j[s])if(x){var u=document.createDocumentFragment();d(j[s],s,u),i.insertBefore(u,f.element[0])}else if("order"==n){h.models.splice(s,1),h.models.push(f);var w=f.element;w.forEach(function(a){i[q](a,o)}),s--}else{h.models.splice(s,1);var t=f.element;t.forEach(function(a){i.removeChild(a)}),s--,y--}else{var z=getDifferents(j[s],f.model);if(z.state)continue;if("object"==$.type(j[s]))for(var A in j[s])f.model[A]=j[s][A];for(var B in f.subscriber)f.apply(B)}else{var u=document.createDocumentFragment();d(j[s],s,u),f=h.models[s-1];var v=f.element[f.element.length-1];v.nextSibling?i.insertBefore(u,v.nextSibling):i.appendChild(u)}return void(e&&g.defaultSelected(e))}if("order"!=n){var u=document.createDocumentFragment();for(var s in j)"array"==k&&Array.prototype[s]||d(j[s],s,u);h.options.repeat?h.nextSibling?i.insertBefore(u,h.nextSibling):i.appendChild(u):a.appendChild(u),e&&g.defaultSelected(e)}}},arrayOrder:function(a,b){"array"==$.type(a)&&(a=a[0]);var c=this,d=b.key,e=new Function("a","return a."+d)(this.model),f=$.type(e),g=[],h=[];for(var i in e)"array"==f&&Array.prototype[i]||a&&g.push(new Function("a","return a."+a)(e[i]));if(!(g.length<=1)){g.sort();var i,j,k=g.length;if("array"==f)for(i=0;k>i;i++)j=e[i],new Function("a","return a."+a)(j)!==g[i]&&(e.splice(i,1),e.push(j),i--);else{for(i in e)h.push({key:i,value:e[i]}),delete e[i];for(i=0;k>i;i++)j=h[i],new Function("a","return a."+a)(j.value)!==g[i]?(h.splice(i,1),h.push(j),i--):e[j.key]=j.value}var l=this.subscriber[d]||[];l.forEach(function(a){var b=a.node;b.$each?c.applyArray(b,d,{action:"order",_array:h}):c.updateNode(a,d)})}},defaultSelected:function(node){var $$sel=node.getAttribute(_config.model);with(this.model)$$sel="undefined"==eval("typeof "+$$sel)?void 0:eval($$sel);if($$sel){var selected="array"==$.type($$sel)?$$sel:[$$sel];nodeToArray(node.options).forEach(function(a){a.$data&&(a.selected=selected.indexOf(a.$data)>=0&&!0)})}}},Module.items={},Module.get=function(a,b){var c=Module.items[a];if(c){var d=$.type(c.value);return"object"==d&&(c._value=$.extend(!0,{},c.value)),c.subscriber[b.name]=b,c}},Module.delay={},Module.set=function(a,b,c){var d=a.split(".");if(!(d.length<2)){var e=d[0],f=d.slice(1,d.length).join("."),g=Module.items[e],h=g.subscriber;null!=b&&new Function("mod","v","mod."+f+"=v")(g.value,b);var i,j;for(i in h)j=h[i],j.scope.options.name!=c&&j.scope.apply(j.key+"."+f,"once")}};var exports={start:function(){var a=_config.controller+"-auto",b=$(document.body).find("["+a+"]");b.each(function(){new Controller(this)})},controller:function(a,b){var c=$(document.body).find("["+_config.controller+'="'+a+'"]')[0];return new Controller(c,b,{name:a}).model},module:function(a,b){return new Module(a,b)},$set:function(a,b,c){Module.delay[a]&&clearTimeout(Module.delay[a]),Module.delay[a]=setTimeout(function(){Module.set(a,b,c),delete Module.delay[a]},1)}};return exports});